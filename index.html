<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>NVD GUI 0.0.4</title>
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
</head>

<body>
  <div class="w3-container w3-teal">
    <h1>NVD GUI 0.0.4</h1>
  </div>
  <!-- All of the Node.js APIs are available in this renderer process. -->

  <form id="main" class="w3-panel w3-white w3-card-4 w3-container w3-content w3-animate-bottom	">
    <h2>Search Type:</h2>
    <p>
      <input type="radio" class="w3-radio" name="executeType" value="full" checked>
      <label>Full</label>
    </p>
    <p>
      <input type="radio" class="w3-radio" name="executeType" value="recent">
      <label>Recent</label>
    </p>
    <div id="yearSelectAreaForFull" name="YearSelectAreaForFull" hidden="true">
      <br>
      <h2>Year to Search:</h2>
      <select name="yearSelectDropDownFull">
        <option value="2018">2018</option>
        <option value="2017">2017</option>
        <option value="2016">2016</option>
        <option value="2015">2015</option>
        <option value="2014">2014</option>
        <option value="2013">2013</option>
        <option value="2012">2012</option>
        <option value="2011">2011</option>
        <option value="2010">2010</option>
      </select>
    </div>
    <br>
    <h2>Search Term:</h2>
    <input type="text" class="w3-input" id="searchTerm" name="searchTerm" value="search_term">
    <br>
    <h2>Options:</h2>
    <input type="checkbox" name="writeReportToDisk" value="Write report to file..."> Custom output Location${outputLocation here}
    <input type="button" name="BrowseReportLocation" value="Browse">
    <br>
    <input type="checkbox" name="customChecklist" value="Get custom checklist"> Custom checklist JSON file
    <input type="button" name="BrowseChecklistLocation" value="Browse">
    <br>
    <h2>Type of file to output:</h2>
    <input type="radio" name="outputType" value=".pdf" checked> PDF
    <br>
    <input type="radio" name="outputType" value=".txt"> TXT
    <br>
    <br>
    <input type="submit" value="Generate report">
    <br>
    <br>
  </form>

  <script>
    // TODO: Get the buttons working
    // TODO: Allow a custom filename/location
    // TODO: Allow for a checklist to be used
    // TODO: Add more features that make sense
    // TODO: handle the larger PDFs sometimes freaking out

    // You can also require other files to run in this process
    require('./renderer.js');
    const { BrowserWindow } = require('electron').remote;
    const PDFWindow = require('electron-pdf-window');
    let nvd = require('./nvd-exports.js');

    // Since the default search radio button select is full, show the elements needed on start
    document.getElementById("yearSelectAreaForFull").hidden = false;

    var form = document.forms['main'];
    // Modify our form option hide/showing of elements depending on what's selected
    form.executeType[0].onclick = function () {
      document.getElementById("yearSelectAreaForFull").hidden = false;
      enableChecklistOption();
    }
    form.executeType[1].onclick = function () {
      document.getElementById("yearSelectAreaForFull").hidden = true;
      enableChecklistOption();
    }

    // process the form locally
    function processForm(e) {
      if (form.searchTerm.value == '' || form.searchTerm.value.length < 3) {
        return alert('Please provide a search term with at least 3 characters')
      }
      if (e.preventDefault) e.preventDefault();
      let argsObj = {};
      // collect all of the current form values
      argsObj.executeType = form.executeType.value;
      argsObj.outputType = form.outputType.value;
      if (form.executeType.value == 'recent') {
        argsObj.searchTerm = form.searchTerm.value;
        argsObj.searchType = form.searchType.value;
      } else if (form.executeType.value == 'full') {
        // use the same searchYear opt as above because we already know the execute type
        // and don't need to worry
        argsObj.searchYear = form.yearSelectDropDownFull.value;
        argsObj.searchTerm = form.searchTerm.value;
        argsObj.searchType = form.searchType.value;
      }
      nvd.executeNVDCheck(argsObj)
        .then(() => {
          // open the generated PDF/TXT file
          const win = new BrowserWindow({ width: 800, height: 600 });
          PDFWindow.addSupport(win);
          console.log(process.cwd());
          if (form.outputType.value == '.pdf') {
            win.loadURL(`${process.cwd()}/test.pdf`);
          } else if (form.outputType.value == '.txt') {
            win.loadURL(`file://${process.cwd()}/test.txt`);
          }
        })
      // return all of the info to nvd-exports here!
      // You must return false to prevent the default form behavior
      return false;
    }

    function disableChecklistOption() {
      form.customChecklist.disabled = true;
      form.BrowseChecklistLocation.disabled = true;
    }

    function enableChecklistOption() {
      form.customChecklist.disabled = false;
      form.BrowseChecklistLocation.disabled = false;
    }

    if (form.attachEvent) {
      form.attachEvent("submit", processForm);
    } else {
      form.addEventListener("submit", processForm);
    }
  </script>
</body>

</html>